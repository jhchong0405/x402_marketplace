# AI 黄金价格预测 × Polymarket 回测系统

> 基于 AI 回归模型预测黄金价格涨跌，并在 Polymarket 预测市场上进行自动化交易回测。

---

## 一、项目概述

本系统包含两大核心功能：

1. **实时预测**：融合 AI 定性分析 + Logistic 回归模型，预测指定日期的黄金价格涨跌概率
2. **历史回测**：在 Polymarket 的 Gold (GC) Up/Down 二元事件上，模拟每小时交易决策，验证策略盈利能力

---

## 二、系统架构

```
┌──────────────────────────────────────────────────────────────┐
│                      数据层                                    │
│  ┌─────────────┐  ┌─────────────┐  ┌──────────────────────┐  │
│  │ Yahoo Finance│  │ 新闻 RSS    │  │ Dome API (Polymarket)│  │
│  │ 金价 + 宏观  │  │ 黄金相关新闻│  │ 事件 + K线价格       │  │
│  └──────┬──────┘  └──────┬──────┘  └──────────┬───────────┘  │
│         │                │                     │              │
├─────────┼────────────────┼─────────────────────┼──────────────┤
│         ▼                ▼                     │              │
│  ┌─────────────────────────────┐               │   预测层     │
│  │  AI 因素收集 + 深度分析      │               │              │
│  │  (Qwen / OpenAI 大模型)     │               │              │
│  └──────────┬──────────────────┘               │              │
│             ▼                                  │              │
│  ┌─────────────────────────────┐               │              │
│  │  Logistic 回归模型           │               │              │
│  │  10个宏观指标 × 365天窗口    │               │              │
│  │  输出: P(Up) 上涨概率        │               │              │
│  └──────────┬──────────────────┘               │              │
│             │                                  │              │
├─────────────┼──────────────────────────────────┼──────────────┤
│             ▼                                  ▼   回测层     │
│  ┌───────────────────────────────────────────────────────┐   │
│  │  回测引擎                                               │   │
│  │  模型概率 vs Polymarket 市场定价 → Edge → 交易决策       │   │
│  │  每小时检查 × 严格模式 × 置信度过滤                      │   │
│  └───────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────┘
```

---

## 三、预测模型

### 3.1 预测流程（8 步）

| 步骤 | 模块 | 说明 |
|------|------|------|
| 1 | `price_fetcher.py` | 获取 365 天历史黄金价格（Yahoo Finance） |
| 2 | `news_fetcher.py` | 抓取最近 3 天黄金相关新闻（RSS） |
| 3 | `factor_collector.py` | AI 大模型基于新闻提取影响金价的关键因素 |
| 4 | `deep_analyzer.py` | AI 大模型做深度分析，输出看涨/看跌倾向 |
| 5 | `factor_data.py` | AI 从 65 个代理指标中动态选择 8-15 个最相关的 |
| 6 | `factor_data.py` | 爬取所选代理指标的日度数据（Yahoo Finance） |
| 7 | `regression.py` | 构建特征矩阵，训练 Logistic 回归，输出 P(Up) |
| 8 | `regression.py` | 融合回归定量结果 + AI 定性判断 → 最终概率 |

### 3.2 代理指标库（65 个指标，12 大分类）

系统内置了覆盖全球宏观经济的 **65 个量化代理指标**，定义在 `factor_data.py` 的 `FACTOR_PROXY_REGISTRY` 中：

#### 一、美联储货币政策 / 美国利率（8 个）

| 代码 | 名称 | Ticker | 方向 | 传导逻辑 |
|------|------|--------|------|----------|
| `us_10y_yield` | 美国10年期国债收益率 | ^TNX | **反向** | 长端利率↑ → 持有黄金的机会成本增加（黄金不生息）→ 资金流出黄金 → 金价↓ |
| `us_2y_yield` | 美国2年期国债收益率 | 2YY=F | **反向** | 短端利率直接反映美联储加息/降息预期，加息预期↑ → 美元走强 → 金价↓ |
| `us_3m_yield` | 美国3月期国债收益率 | ^IRX | **反向** | 最短端利率，紧贴联邦基金利率，利率↑ → 金价↓ |
| `us_30y_yield` | 美国30年期国债收益率 | ^TYX | **反向** | 超长端利率反映长期通胀和经济增长预期，收益率↑ → 金价↓ |
| `us_5y_yield` | 美国5年期国债收益率 | ^FVX | **反向** | 中端利率，与中期通胀预期相关，收益率↑ → 金价↓ |
| `tlt_bond_etf` | 美国20年+国债ETF | TLT | **正向** | TLT价格↑ = 长端利率↓ = 持有黄金机会成本↓ → 金价↑ |
| `shy_short_bond` | 美国1-3年短期国债ETF | SHY | **AI判断** | 短债ETF反映近期利率预期变化，方向取决于当前市场环境（降息周期正向，加息周期反向） |
| `fed_funds_futures` | 联邦基金利率期货 | ZQ=F | **AI判断** | 直接反映市场对下次FOMC会议利率决议的定价，需结合当前政策周期判断方向 |

#### 二、欧洲央行 / 欧洲利率（4 个）

| 代码 | 名称 | Ticker | 方向 | 传导逻辑 |
|------|------|--------|------|----------|
| `eurusd` | 欧元兑美元 | EURUSD=X | **正向** | 欧元走强 = 美元走弱 → 以美元计价的黄金对其他货币持有者更便宜 → 需求↑ → 金价↑ |
| `german_10y_bund` | 德国10年期国债ETF | IBGL.L | **AI判断** | ECB鹰派 → 德债价格↓ → 欧洲利率↑，但同时可能引发欧元走强，对金价影响需AI综合判断 |
| `euro_stoxx50` | 欧洲斯托克50指数 | ^STOXX50E | **AI判断** | 欧洲股市↑可能反映风险偏好↑（利空黄金），也可能反映欧洲经济强劲+欧元走强（利多黄金） |
| `eurchf` | 欧元兑瑞郎 | EURCHF=X | **反向** | 欧元贬值兑瑞郎(↓) = 欧洲避险情绪升温 → 资金流向避险资产 → 金价↑ |

#### 三、美国通胀数据（5 个）

| 代码 | 名称 | Ticker | 方向 | 传导逻辑 |
|------|------|--------|------|----------|
| `tips_etf` | 通胀保值债券ETF(TIPS) | TIP | **正向** | TIP价格↑ = 市场通胀预期升温 → 黄金作为抗通胀资产需求↑ → 金价↑ |
| `breakeven_10y` | 10年期盈亏平衡通胀率 | T5YIE=F | **正向** | 盈亏平衡通胀率↑ = 市场预期未来通胀更高 → 黄金抗通胀价值↑ → 金价↑ |
| `commodity_index` | 彭博大宗商品指数ETN | DJP | **正向** | 大宗商品整体上涨反映输入性通胀压力 → 黄金跟随商品周期上涨 |
| `copper` | 铜期货 | HG=F | **正向** | 铜价↑ = 经济过热/通胀压力 → 通胀对冲需求↑ → 金价↑（"铜博士"是经济温度计） |
| `wheat` | 小麦期货 | ZW=F | **正向** | 粮食价格↑ = 食品通胀 → CPI上行压力 → 黄金抗通胀需求↑ → 金价↑ |

#### 四、美元指数 / 汇率（7 个）

| 代码 | 名称 | Ticker | 方向 | 传导逻辑 |
|------|------|--------|------|----------|
| `dxy` | 美元指数(DXY) | DX-Y.NYB | **反向** | 美元走强 → 黄金以美元计价变贵 → 全球需求↓ → 金价↓（黄金与美元长期负相关） |
| `usdjpy` | 美元兑日元 | JPY=X | **反向** | 日元走强(数值↓) = 全球避险情绪升温 → 资金涌入避险资产 → 金价↑ |
| `usdchf` | 美元兑瑞郎 | CHF=X | **反向** | 瑞郎走强(数值↓) = 避险需求 → 黄金同为避险资产受益 → 金价↑ |
| `usdcny` | 美元兑人民币 | CNY=X | **AI判断** | 人民币贬值(↑) → 中国投资者买入黄金避险 → 利多；但也可能反映美元走强 → 利空，需AI综合判断 |
| `usdinr` | 美元兑印度卢比 | INR=X | **AI判断** | 印度是全球第二大黄金消费国，卢比贬值使黄金进口成本↑ → 短期需求↓，但长期避险需求↑，方向需AI判断 |
| `gbpusd` | 英镑兑美元 | GBPUSD=X | **正向** | 英镑走强(↑) = 美元走弱 → 金价↑ |
| `uup_dollar_etf` | 美元看涨ETF | UUP | **反向** | UUP↑ = 美元走强 → 金价↓ |

#### 五、地缘政治风险（7 个）

| 代码 | 名称 | Ticker | 方向 | 传导逻辑 |
|------|------|--------|------|----------|
| `vix` | VIX恐慌指数 | ^VIX | **正向** | VIX飙升 = 市场恐慌/不确定性↑ → 资金涌入黄金避险 → 金价↑ |
| `crude_oil` | WTI原油期货 | CL=F | **正向** | 油价飙升常伴随中东地缘冲突升级 → 避险情绪↑ + 通胀预期↑ → 金价↑ |
| `brent_oil` | 布伦特原油期货 | BZ=F | **正向** | 国际油价基准，对中东局势更敏感，逻辑同WTI |
| `nat_gas` | 天然气期货 | NG=F | **AI判断** | 天然气价格飙升常与俄乌/欧洲能源危机相关 → 利多黄金；但也可能是季节性因素，需AI判断 |
| `defense_etf` | 美国国防军工ETF | ITA | **正向** | 军工股↑ = 市场预期地缘冲突升级/军费增加 → 避险需求↑ → 金价↑ |
| `israel_etf` | 以色列ETF | EIS | **反向** | EIS↓ = 中东局势恶化 → 地缘风险↑ → 避险买入黄金 → 金价↑ |
| `vxus_intl_stock` | 国际(除美)股票ETF | VXUS | **反向** | 国际股市↓ = 全球风险上升 → 资金从风险资产流向黄金 → 金价↑ |

#### 六、市场情绪 / 风险偏好（6 个）

| 代码 | 名称 | Ticker | 方向 | 传导逻辑 |
|------|------|--------|------|----------|
| `sp500` | 标普500指数 | ^GSPC | **反向** | 股市↑ = 风险偏好高 → 资金追逐高收益资产 → 流出黄金 → 金价↓ |
| `nasdaq` | 纳斯达克指数 | ^IXIC | **反向** | 科技股↑ = 风险偏好极高 → 黄金作为防御资产被抛售 → 金价↓ |
| `russell2000` | 罗素2000小盘股 | ^RUT | **反向** | 小盘股↑ = 经济信心强/风险偏好高 → 黄金需求↓ → 金价↓ |
| `hyg_junk_bond` | 高收益债券ETF | HYG | **反向** | HYG↓ = 信用利差扩大 = 市场风险厌恶↑ → 资金流入黄金避险 → 金价↑ |
| `put_call_ratio` | VIX 9日短期恐慌 | ^VIX9D | **正向** | 超短期恐慌指标飙升 = 极端恐慌情绪 → 短期避险买盘涌入 → 金价↑ |
| `move_bond_vol` | MOVE债券波动率 | ^MOVE | **正向** | 债市波动加剧 = 金融系统压力↑ → 系统性风险担忧 → 避险买金 → 金价↑ |

#### 七、美国就业 / 经济数据（5 个）

| 代码 | 名称 | Ticker | 方向 | 传导逻辑 |
|------|------|--------|------|----------|
| `us_unemployment_etf` | 金融板块ETF | XLF | **反向** | 金融股↓ = 经济/就业担忧 → 美联储可能降息 → 利率↓ + 避险↑ → 金价↑ |
| `us_consumer_etf` | 非必需消费品ETF | XLY | **反向** | 消费股↓ = 就业/消费疲软 → 经济衰退预期 → 美联储宽松预期↑ → 金价↑ |
| `us_industrial_etf` | 工业板块ETF | XLI | **AI判断** | 工业股反映制造业活动：↓可能意味衰退（利多黄金），但也可能是行业轮动，需AI判断 |
| `us_transport` | 运输业ETF | IYT | **反向** | 运输股是经济领先指标，IYT↓ = 经济放缓信号 → 宽松预期↑ → 金价↑ |
| `us_housing` | 住宅建筑ETF | XHB | **AI判断** | 房地产对利率极敏感：XHB↓可能反映利率过高（利空黄金）或经济衰退（利多黄金），需AI判断 |

#### 八、全球经济增长（6 个）

| 代码 | 名称 | Ticker | 方向 | 传导逻辑 |
|------|------|--------|------|----------|
| `eem_emerging` | 新兴市场ETF | EEM | **反向** | 新兴市场↓ = 全球增长放缓 + 资本外流 → 避险需求↑ → 金价↑ |
| `fxi_china` | 中国大盘股ETF | FXI | **AI判断** | 中国是全球最大黄金消费国：经济好→实物需求↑（利多），但也→风险偏好↑（利空），需AI判断 |
| `ewj_japan` | 日本ETF | EWJ | **AI判断** | 日央行政策影响全球资金流：日本加息→日元升值→套利交易平仓→全球波动↑，方向需AI判断 |
| `nikkei225` | 日经225指数 | ^N225 | **AI判断** | 日股表现反映亚太经济和日央行政策，对金价影响取决于具体驱动因素，需AI判断 |
| `shanghai_composite` | 上证综合指数 | 000001.SS | **AI判断** | 中国股市与黄金需求关系复杂：股市差→避险买金（利多），但也→经济差→消费力↓（利空） |
| `baltic_dry` | 波罗的海干散货运价ETF | BDRY | **反向** | 全球贸易活动领先指标，BDRY↓ = 全球经济放缓 → 宽松预期↑ + 避险↑ → 金价↑ |

#### 九、黄金ETF持仓 / 实物需求 / 央行购金（9 个）

| 代码 | 名称 | Ticker | 方向 | 传导逻辑 |
|------|------|--------|------|----------|
| `gld_price` | 黄金ETF(GLD)价格 | GLD | **正向** | 全球最大黄金ETF，价格直接跟踪金价，GLD↑ = 金价↑ |
| `gld_volume` | 黄金ETF(GLD)成交量 | GLD | **正向** | 成交量放大 = 市场对黄金关注度↑ + 资金流入↑ → 金价↑ |
| `iau_etf` | iShares黄金ETF | IAU | **正向** | 第二大黄金ETF，成交量变化反映机构配置需求，IAU↑ = 机构看好黄金 |
| `gdx_miners` | 黄金矿业ETF | GDX | **正向** | 金矿股↑ = 市场看好黄金前景 + 央行购金预期 → 金价↑（金矿股是金价的杠杆版） |
| `gdxj_junior_miners` | 小型黄金矿业ETF | GDXJ | **正向** | 小型金矿股对金价更敏感，是金价方向的放大器，GDXJ↑ = 强烈看涨信号 |
| `silver` | 白银期货 | SI=F | **正向** | 白银与黄金高度正相关（相关系数~0.8），白银↑ → 贵金属整体需求强 → 金价↑ |
| `slv_silver_etf` | 白银ETF | SLV | **正向** | 白银ETF资金流入反映贵金属整体配置需求↑ → 金价↑ |
| `platinum` | 铂金期货 | PL=F | **AI判断** | 铂金兼具贵金属+工业属性：铂金↑可能是避险（利多黄金）或工业需求（与黄金无关），需AI判断 |
| `palladium` | 钯金期货 | PA=F | **AI判断** | 钯金主要用于汽车催化剂，工业属性强，与黄金的关联度取决于当前市场主题，需AI判断 |

#### 十、技术面信号代理（3 个）

| 代码 | 名称 | Ticker | 方向 | 传导逻辑 |
|------|------|--------|------|----------|
| `gold_futures_volume` | 黄金期货成交量 | GC=F | **AI判断** | 成交量放大+价格↑ = 趋势确认（利多）；成交量放大+价格↓ = 抛售确认（利空），需结合价格判断 |
| `gold_silver_ratio` | 金银比 | SI=F | **AI判断** | 金银比↑ = 避险情绪主导（利多黄金）；金银比↓ = 工业需求/风险偏好回升（利空黄金） |
| `gdx_gld_ratio` | 金矿股/金价比 | GDX | **AI判断** | GDX跑赢GLD = 市场看好金价继续上涨（利多）；GDX跑输GLD = 可能见顶信号（利空） |

#### 十一、加密货币（替代资产）（2 个）

| 代码 | 名称 | Ticker | 方向 | 传导逻辑 |
|------|------|--------|------|----------|
| `bitcoin` | 比特币 | BTC-USD | **AI判断** | BTC被称为"数字黄金"：有时与黄金同涨（共同避险），有时此消彼长（资金替代），关系不稳定需AI判断 |
| `ethereum` | 以太坊 | ETH-USD | **AI判断** | 加密市场整体情绪指标：ETH↑可能反映风险偏好↑（利空黄金），也可能反映法币信心↓（利多黄金） |

#### 十二、其他宏观（3 个）

| 代码 | 名称 | Ticker | 方向 | 传导逻辑 |
|------|------|--------|------|----------|
| `us_reit` | 美国房地产信托ETF | VNQ | **反向** | REIT对利率极敏感，VNQ↓ = 利率上升预期 → 持有黄金机会成本↑ → 金价↓ |
| `us_utilities` | 公用事业板块ETF | XLU | **正向** | 防御性板块，XLU↑ = 资金转向防御/避险 → 黄金同为避险资产受益 → 金价↑ |
| `lumber` | 木材期货 | LBS=F | **AI判断** | 木材价格反映房地产和建筑活动，是经济领先指标，对金价影响取决于经济周期阶段，需AI判断 |

> **方向说明**：**正向** = 该指标↑时金价倾向↑；**反向** = 该指标↑时金价倾向↓；**AI判断** = 该指标与金价的关系取决于当前市场环境，由 AI 大模型在实时预测时动态判断方向和权重。

### 3.3 指标选择方式（三种模式）

系统支持三种指标选择模式，实时预测和回测均可使用：

| 模式 | 命令参数 | 指标选择 | 速度 | 适用场景 |
|------|---------|---------|------|---------|
| **fast** | `--model-mode fast` | 固定 10 个核心指标 | 最快（无 AI 调用） | 快速回测验证 |
| **ai_select** | `--model-mode ai_select` | AI 从 65 个中动态选 8-15 个 | 中等（每事件 ~15s） | 精准回测 / 实盘 |
| **full** | `--model-mode full` | AI 选指标 + AI 定性融合 | 最慢（每事件 ~30s） | 最高精度实盘 |

**fast 模式默认 10 个核心指标**：`us_10y_yield`, `us_2y_yield`, `dxy_index`, `sp500`, `vix`, `oil_wti`, `silver`, `tips_etf`, `gld_volume`, `copper`

**ai_select 模式**：AI 大模型根据历史金价走势和宏观环境，从 65 个指标库中为每个预测日期选择最相关的 8-15 个指标，并分配权重和方向。不同日期会选出不同的指标组合，更贴合当时的市场主题。

### 3.4 模型方法

- **算法**：Logistic 回归（sklearn LogisticRegression）
- **训练窗口**：365 天滚动窗口
- **标签**：未来 N 天金价涨跌（二分类）
- **特征工程**：每个代理指标生成 5 个特征（日变化率、5日变化率、20日变化率、MA20偏离、20日波动率）
- **预测输出**：`P(Up)` 上涨概率（0~1）
- **融合**（仅实时预测）：回归定量结果 × 权重 + AI 定性判断 × 权重 → 最终概率

### 3.5 运行实时预测

```bash
python gold_analyzer/main.py
# 输入预测目标日期，例如: 2026-02-10
# 输出: 完整分析报告 + JSON 文件
```

---

## 四、交易策略

### 4.1 交易标的

Polymarket 上每个交易日有一个二元事件：**"Gold (GC) Up or Down on [日期]?"**

- **Up token**：当天金价上涨 → 结算价 $1；下跌 → 结算价 $0
- **Down token**：当天金价下跌 → 结算价 $1；上涨 → 结算价 $0
- 两个 token 价格之和 ≈ $1（互补关系）

### 4.2 交易决策流程

```
┌─────────────────────────────────────────────────────┐
│  Step 1: 站在前一天，运行 AI 回归模型                    │
│  输入: 365天历史金价 + 10个宏观指标                      │
│  输出: P(Up) = 模型预测的上涨概率                        │
│  例: P(Up) = 83% → 模型预测方向 = Up                    │
├─────────────────────────────────────────────────────┤
│  Step 2: 每小时检查 Polymarket 市场定价                  │
│  读取: Up token 当前价格（= 市场隐含上涨概率）             │
│  例: Up token = $0.55 → 市场认为上涨概率 55%             │
├─────────────────────────────────────────────────────┤
│  Step 3: 计算 Edge（模型 vs 市场的差异）                  │
│  Edge = 模型概率 - 市场定价 = 83% - 55% = +28%          │
├─────────────────────────────────────────────────────┤
│  Step 4: 交易决策（三重过滤）                             │
│  ① 置信度过滤: 模型置信度 >= 80% 才交易                   │
│  ② 严格模式: 只允许交易方向与模型预测方向一致               │
│  ③ Edge 过滤: Edge > 5% 阈值才交易                       │
│  全部通过 → 买入 $1 的对应 token                         │
└─────────────────────────────────────────────────────┘
```

### 4.3 四种场景

| 场景 | 模型 | 市场 | Edge | 决策 |
|------|------|------|------|------|
| 模型看涨 + 市场低估 | P(Up)=83% | Up=$0.55 | +28% | ✅ 买 Up token |
| 模型看跌 + 市场低估 | P(Up)=5% | Down=$0.30 | +65% | ✅ 买 Down token |
| 模型看涨 + 市场更看涨 | P(Up)=57% | Up=$0.84 | -27% | ❌ 不交易（没优势） |
| 模型看涨 + 差异太小 | P(Up)=60% | Up=$0.58 | +2% | ❌ 不交易（edge不够） |

### 4.4 盈亏计算

```
买入 $1 的 Up token @ $0.55
→ 获得 1/0.55 = 1.818 份

如果金价上涨（Up 赢）:
  收入 = 1.818 × $1 = $1.818
  盈利 = $1.818 - $1.00 = +$0.82  (+81.8%)

如果金价下跌（Down 赢）:
  收入 = 1.818 × $0 = $0
  亏损 = $0 - $1.00 = -$1.00  (-100%)
```

**关键特性**: 每笔最多亏 $1，但盈利无上限（买入价越低，盈利倍数越高）。

---

## 五、回测方法

### 5.1 回测数据

- **时间范围**: 2025 年 10 月 ~ 2026 年 2 月
- **事件数量**: 47 个已结算的 Gold GC Up/Down 事件
- **实际结果分布**: Up = 28 (60%) | Down = 19 (40%)
- **价格数据**: 每个事件的小时级 K 线（通过 Dome API 获取）

### 5.2 回测流程

```
Step 1: 获取 Polymarket 历史数据
  └─ 通过 Dome API 搜索所有已结算的 "Gold GC Up or Down" 事件
  └─ 获取每个事件的小时级 K 线（Up/Down token 价格）
  └─ 获取每个事件的结算结果（Up 赢还是 Down 赢）

Step 2: 对每个事件运行 AI 模型预测
  └─ 站在前一天视角（只用 target_date 之前的数据）
  └─ 获取历史金价
  └─ fast 模式: 使用固定 10 个核心指标
  └─ ai_select 模式: AI 从 65 个指标中动态选 8-15 个
  └─ 训练 Logistic 回归 → 输出 P(Up)

Step 3: 模拟交易
  └─ 遍历每个事件的每个小时级价格点
  └─ 置信度过滤 → 严格模式过滤 → Edge 过滤
  └─ 通过全部过滤 → 买入 $1 的对应 token

Step 4: 结算 & 统计
  └─ 买对方向 → 盈利 = (1 - 买入价) / 买入价
  └─ 买错方向 → 亏损 = -$1
  └─ 汇总: 胜率、总盈亏、ROI、最大回撤、夏普比率
```

### 5.3 指标定义

| 指标 | 公式 |
|------|------|
| **胜率** | 盈利交易数 / 总交易数 |
| **总盈亏 (PnL)** | Σ 每笔交易盈亏 |
| **ROI** | 总盈亏 / 总投入 × 100% |
| **最大回撤** | 权益曲线从峰值到谷值的最大跌幅 |
| **Sharpe (简化)** | mean(每笔PnL) / std(每笔PnL) |

---

## 六、回测结果

### 6.1 策略优化历程

| 版本 | 策略 | 指标选择 | 参与事件 | 胜率 | ROI | Sharpe |
|------|------|---------|---------|------|-----|--------|
| V1 原始模式 | 双向交易，无过滤 | 固定10个 | 47 | 39.4% | +51.4% | 0.118 |
| V2 严格模式 | 只跟模型方向交易 | 固定10个 | 47 | 52.0% | +70.1% | 0.160 |
| **V3 最终版** | **严格 + 置信度≥80%** | **固定10个** | **17** | **80.7%** | **+54.7%** | **0.427** |
| V4 AI选指标 | 严格 + 置信度≥80% | AI动态选8-15个 | 5 | 69.4% | +39.2% | 0.360 |

### 6.2 各版本完整回测结果

#### V1 原始模式（双向交易，无过滤）

| 指标 | 数值 |
|------|------|
| 参与事件 | 47 个（2025.10 ~ 2026.02） |
| 总交易笔数 | 513 笔（平均每事件 10.9 笔） |
| 胜率 | 39.4%（202 胜 311 负） |
| 总投入 | $513.00 |
| 总盈亏 | +$263.66 |
| 投资回报率 | +51.4% |
| 每笔平均盈亏 | +$0.51 |
| 盈利笔均盈 | +$2.84 |
| 亏损笔均亏 | -$1.00 |
| 单笔最大盈利 | +$49.00 |
| 单笔最大亏损 | -$1.00 |
| 最大回撤 | $72.29 |
| 夏普比率 | 0.118 |
| 模型方向准确率 | 61.7%（29/47 事件） |

#### V2 严格模式（只跟模型方向交易）

| 指标 | 数值 |
|------|------|
| 参与事件 | 47 个（2025.10 ~ 2026.02） |
| 总交易笔数 | 356 笔（平均每事件 7.6 笔） |
| 胜率 | 52.0%（185 胜 171 负） |
| 总投入 | $356.00 |
| 总盈亏 | +$249.61 |
| 投资回报率 | +70.1% |
| 每笔平均盈亏 | +$0.70 |
| 盈利笔均盈 | +$2.27 |
| 亏损笔均亏 | -$1.00 |
| 单笔最大盈利 | +$49.00 |
| 单笔最大亏损 | -$1.00 |
| 最大回撤 | $57.00 |
| 夏普比率 | 0.160 |
| 模型方向准确率 | 57.1%（24/42 事件） |

#### V3 固定指标模式（严格 + 置信度≥80%，`--model-mode fast`）

| 指标 | 数值 |
|------|------|
| 参与事件 | 17 个（2025.10 ~ 2026.02） |
| 总交易笔数 | 145 笔（平均每事件 8.5 笔） |
| 胜率 | **80.7%**（117 胜 28 负） |
| 总投入 | $145.00 |
| 总盈亏 | **+$79.31** |
| 投资回报率 | **+54.7%** |
| 每笔平均盈亏 | +$0.55 |
| 盈利笔均盈 | +$0.92（赢的时候赚得多） |
| 亏损笔均亏 | -$1.00（输的时候最多亏 $1） |
| 单笔最大盈利 | +$5.25 |
| 单笔最大亏损 | -$1.00 |
| 最大回撤 | $14.00 |
| 夏普比率 | **0.427** |
| 模型方向准确率 | **68.8%**（11/16 事件） |

#### V4 AI 选指标模式（严格 + 置信度≥80%，`--model-mode ai_select`）

| 指标 | 数值 |
|------|------|
| 参与事件 | 5 个（2025.10 ~ 2026.02） |
| 总交易笔数 | 36 笔（平均每事件 7.2 笔） |
| 胜率 | **69.4%**（25 胜 11 负） |
| 总投入 | $36.00 |
| 总盈亏 | **+$14.10** |
| 投资回报率 | **+39.2%** |
| 每笔平均盈亏 | +$0.39 |
| 盈利笔均盈 | +$0.96 |
| 亏损笔均亏 | -$1.00 |
| 单笔最大盈利 | +$4.00 |
| 单笔最大亏损 | -$1.00 |
| 最大回撤 | $9.67 |
| 夏普比率 | **0.360** |
| 模型方向准确率 | 60.0%（3/5 事件） |

#### 版本对比分析

| 指标 | V1 原始 | V2 严格 | V3 严格+置信度 | V4 AI选指标 |
|------|--------|--------|--------------|------------|
| 参与事件 | 47 | 47 | 17 | 5 |
| 总交易笔数 | 513 | 356 | 145 | 36 |
| 胜率 | 39.4% | 52.0% | **80.7%** | 69.4% |
| 总盈亏 | +$263.66 | +$249.61 | +$79.31 | +$14.10 |
| ROI | +51.4% | +70.1% | +54.7% | +39.2% |
| 最大回撤 | $72.29 | $57.00 | **$14.00** | $9.67 |
| 夏普比率 | 0.118 | 0.160 | **0.427** | 0.360 |
| 模型方向准确率 | 61.7% | 57.1% | 68.8% | 60.0% |

> **结论**：V3（严格模式 + 置信度≥80%）是综合表现最优的策略，胜率 80.7%、夏普比率 0.427、最大回撤仅 $14。V4 AI 选指标模式的最大回撤更小（$9.67），但因样本量不足（仅 5 个事件）无法得出统计显著结论。**推荐在实盘中使用 `ai_select` 模式获得更精准的预测，回测验证时使用 `fast` 模式保证样本量。**

### 6.3 不同 Edge 阈值对比（严格模式 + 置信度≥80%）

| Edge 阈值 | 交易数 | 胜率 | 总盈亏 | ROI | 最大回撤 | Sharpe |
|-----------|--------|------|--------|-----|----------|--------|
| 2% | 196 | 72.4% | +$99.66 | +50.8% | $26.00 | 0.318 |
| **5%** | **175** | **72.0%** | **+$98.21** | **+56.1%** | **$26.00** | **0.335** |
| 8% | 161 | 72.0% | +$98.21 | +61.0% | $26.00 | 0.345 |
| 10% | 150 | 72.0% | +$97.21 | +64.8% | $26.00 | 0.354 |
| 15% | 131 | 71.0% | +$93.20 | +71.1% | $26.00 | 0.361 |
| 20% | 116 | 69.8% | +$88.93 | +76.7% | $26.00 | 0.362 |

### 6.4 按事件明细（V3 策略）

| 日期 | 模型P(Up) | 实际 | 交易方向 | 交易数 | 盈/亏 | 净盈亏 | ROI |
|------|-----------|------|----------|--------|-------|--------|-----|
| 2025-10-27 | 77.0% | Down | Up | 12 | 0/12 | -$12.00 | -100% |
| 2025-10-28 | 77.0% | Down | Up | 5 | 0/5 | -$5.00 | -100% |
| 2025-11-05 | 90.6% | Up | Up | 5 | 5/0 | +$2.65 | +53% |
| 2025-11-06 | 92.5% | Down | Up | 2 | 0/2 | -$2.00 | -100% |
| 2025-12-09 | 80.4% | Up | Up | 1 | 1/0 | +$0.82 | +82% |
| 2025-12-23 | 82.6% | Up | Up | 5 | 5/0 | +$4.24 | +85% |
| 2025-12-29 | 77.9% | Down | Up | 22 | 0/22 | -$22.00 | -100% |
| 2025-12-30 | 77.9% | Up | Up | 6 | 6/0 | +$4.51 | +75% |
| 2026-01-05 | 83.3% | Up | Up | 7 | 7/0 | +$2.56 | +37% |
| 2026-01-06 | 83.3% | Up | Up | 6 | 6/0 | +$6.52 | +109% |
| 2026-01-12 | 82.4% | Up | Up | 6 | 6/0 | +$15.98 | +266% |
| 2026-01-13 | 82.4% | Down | Up | 5 | 0/5 | -$5.00 | -100% |
| 2026-01-20 | 84.9% | Up | Up | 24 | 24/0 | +$9.86 | +41% |
| 2026-01-21 | 84.9% | Up | Up | 1 | 1/0 | +$0.96 | +96% |
| 2026-01-22 | 81.4% | Up | Up | 15 | 15/0 | +$41.02 | +273% |
| 2026-01-30 | 81.0% | Down | Up | 14 | 0/14 | -$14.00 | -100% |
| 2026-02-04 | 97.7% | Up | Up | 19 | 19/0 | +$14.22 | +75% |
| 2026-02-05 | 10.9% | Down | Down | 16 | 16/0 | +$22.24 | +139% |
| 2026-02-06 | 14.2% | Up | Down | 16 | 0/16 | -$16.00 | -100% |

### 6.5 关键发现

1. **模型预测对 = 该事件全部盈利**：严格模式下，方向正确时所有交易都赢
2. **模型预测错 = 该事件全部亏损**：方向错误时，投入全部归零（每笔 -$1）
3. **盈亏不对称是盈利关键**：赢时平均赚 $1.17，亏时固定 $1 → 胜率 >50% 即可盈利
4. **置信度过滤大幅提升胜率**：从 51%（无过滤）→ 72%（≥80%），代价是事件数 47→19
5. **最大单事件盈利**: 2026-01-22 (+$41.02, ROI +273%)
6. **最大单事件亏损**: 2025-12-29 (-$22.00)，模型看涨但实际下跌，22 小时持续买入

---

## 七、运行方式

### 7.1 安装依赖

```bash
pip install -r gold_analyzer/requirements.txt
```

依赖：`openai`, `yfinance`, `python-dotenv`, `pandas`, `numpy`, `scikit-learn`, `feedparser`

### 7.2 实时预测

```bash
python gold_analyzer/main.py
# 交互式输入目标日期，输出完整分析报告
```

### 7.3 回测

```bash
# V3 最终策略：固定指标 + 严格模式 + 置信度>=80%
python gold_analyzer/run_backtest.py --model --edge 0.05 --strict --min-conf 0.80

# V4 AI选指标：AI动态选指标 + 严格模式 + 置信度>=80%
python gold_analyzer/run_backtest.py --model --model-mode ai_select --edge 0.05 --strict --min-conf 0.80

# 严格模式（无置信度过滤）
python gold_analyzer/run_backtest.py --model --edge 0.05 --strict

# 原始模式（双向交易）
python gold_analyzer/run_backtest.py --model --edge 0.05

# 参数扫描
python gold_analyzer/run_backtest.py --sweep

# 重新获取数据 + 重新预测
python gold_analyzer/run_backtest.py --model --refresh --refresh-predictions --strict --min-conf 0.80
```

### 7.4 命令行参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `--model` | - | 使用 AI 回归模型动态预测 |
| `--model-mode` | fast | `fast`=固定10指标, `ai_select`=AI选指标+回归, `full`=AI选指标+回归+AI融合 |
| `--edge` | 0.05 | 最小 Edge 阈值（5%） |
| `--strict` | - | 严格模式：只跟模型方向交易 |
| `--min-conf` | 0.0 | 最低置信度阈值（推荐 0.80） |
| `--bet` | 1.0 | 每笔投注金额 |
| `--refresh` | - | 强制重新获取 Polymarket 数据 |
| `--refresh-predictions` | - | 强制重新运行模型预测 |
| `--sweep` | - | 固定概率参数扫描模式 |

---

## 八、文件结构

```
gold_analyzer/
├── main.py                    # 实时预测入口（8步完整流程）
├── run_backtest.py            # 回测入口（命令行参数、报告输出）
│
├── price_fetcher.py           # 历史金价获取（Yahoo Finance）
├── news_fetcher.py            # 黄金新闻抓取（RSS）
├── factor_collector.py        # AI 因素收集（大模型提取关键因素）
├── deep_analyzer.py           # AI 深度分析（看涨/看跌判断）
├── factor_data.py             # 代理指标选择 + 数据获取
├── regression.py              # Logistic 回归模型 + 概率融合
├── scoring.py                 # 量化评分
├── reporting.py               # 报告生成
│
├── ai_client.py               # AI 大模型客户端（Qwen/OpenAI）
├── config.py                  # 配置文件
├── .env                       # API 密钥
│
├── polymarket_client.py       # Polymarket 数据客户端（Dome API）
├── model_predictor.py         # 回测用模型预测器（站在前一天预测）
├── backtester.py              # 回测引擎（交易决策、盈亏计算）
│
├── gc_events_cache.json       # Polymarket 事件数据缓存
├── model_predictions_cache.json  # 模型预测结果缓存
├── requirements.txt           # Python 依赖
│
├── README.md                  # 本文件
├── ALL_CODE.md                # 完整代码（Markdown 格式）
├── BACKTEST_README.md         # 回测思路详解
└── BACKTEST_RESULTS.md        # 回测结果详细数据
```

---

## 九、API 与数据源

| 数据源 | 用途 | API |
|--------|------|-----|
| Yahoo Finance | 黄金价格 + 宏观指标 | `yfinance` Python 库 |
| RSS Feeds | 黄金相关新闻 | Google News / Investing.com |
| Qwen / OpenAI | AI 因素分析 + 深度判断 | OpenAI 兼容 API |
| Dome API | Polymarket 事件 + K线 | `api.domeapi.io/v1/polymarket` |
