# Polymarket 黄金 GC 回测系统 — 完整思路

## 一、核心思想

> **如果我的 AI 模型预测的概率和 Polymarket 市场定价不一致，就按我的模型方向交易。**

这是经典的"预测市场套利"策略：
- Polymarket 上每天有一个事件："Gold (GC) Up or Down on [日期]?"
- 市场参与者买卖形成的价格 = 市场对该事件的隐含概率
- 我的 AI 回归模型也会预测一个概率
- 当两者差异足够大（edge > 阈值），说明市场"错误定价"，我就下注

---

## 二、数据来源

### 2.1 Polymarket 事件数据（通过 Dome API）
- **事件**：`Gold (GC) Up or Down on January 8?` — 每个交易日一个
- **两个 token**：
  - `Up` token：如果当天金价上涨，结算价 = $1；否则 = $0
  - `Down` token：如果当天金价下跌，结算价 = $1；否则 = $0
- **价格**：Up + Down ≈ $1.00（近似互补）
- **小时级 K 线**：通过 Dome API 的 candlesticks 端点获取，interval=60

### 2.2 AI 回归模型预测
- 使用 `model_predictor.py`，对每个事件的目标日期：
  1. **站在前一天**（end_date = target_date - 1）
  2. 获取截至前一天的历史金价（365天）
  3. 获取截至前一天的 10 个宏观代理指标（美债收益率、美元指数、VIX 等）
  4. 构建特征矩阵，训练 Logistic 回归模型
  5. 输出：`P(Up) = 0.05`（即模型认为明天上涨概率 5%，下跌概率 95%）

---

## 三、交易策略

### 3.1 Edge 计算

```
模型预测：P(Up) = 60%, P(Down) = 40%
市场定价：Up token = $0.50, Down token = $0.50

Edge_Up   = P(Up)_模型 - Price_Up_市场   = 60% - 50% = +10%  → 模型认为 Up 被低估
Edge_Down = P(Down)_模型 - Price_Down_市场 = 40% - 50% = -10% → 模型认为 Down 被高估
```

### 3.2 交易决策（每小时检查一次）

```
如果 Edge_Up > 阈值 且 Edge_Up >= Edge_Down:
    → 买入 $1 的 Up token
如果 Edge_Down > 阈值 且 Edge_Down > Edge_Up:
    → 买入 $1 的 Down token
否则:
    → 不交易（市场定价和模型差不多）
```

### 3.3 为什么不需要"卖空"？

Polymarket 是二元期权市场：
- 买 Down token = 等于在"做空"金价
- 买 Up token = 等于在"做多"金价
- 不需要借券、不需要保证金，直接买对应方向的 token 即可

### 3.4 Edge 阈值（`--edge`）的含义

| edge 阈值 | 含义 | 效果 |
|-----------|------|------|
| 0.02 (2%) | 很小的差异就交易 | 交易多，但很多是噪音 |
| 0.05 (5%) | 中等差异才交易 | 平衡交易数量和质量 |
| 0.10 (10%) | 较大差异才交易 | 交易少，但每笔更有把握 |
| 0.20 (20%) | 很大差异才交易 | 只抓极端错误定价 |

---

## 四、盈亏计算

### 4.1 单笔交易

```
买入 Down token @ $0.30（花 $1 买入 1/0.30 = 3.33 份）

情况 A：金价下跌（Down 赢）
  → 每份 token 结算价 = $1
  → 收入 = 3.33 × $1 = $3.33
  → 盈利 = $3.33 - $1.00 = +$2.33

情况 B：金价上涨（Up 赢）
  → 每份 token 结算价 = $0
  → 收入 = 3.33 × $0 = $0
  → 亏损 = $0 - $1.00 = -$1.00
```

**关键特性**：
- **最大亏损 = 投入金额**（$1），不会更多
- **盈利上限 = (1/买入价 - 1) × 投入金额**，买入价越低盈利越大
- 这就是为什么胜率只有 38% 但总盈亏是正的 — 赢的时候赚得多，输的时候最多亏 $1

### 4.2 每小时多笔交易

每个事件存续约 24-48 小时，每小时检查一次市场价格：
- 如果市场一直"错误定价"，每小时都会买入 $1
- 同一个事件可能产生 5-20 笔交易
- 所有交易在事件结算时统一清算

---

## 五、回测流程

```
Step 1: 获取 Polymarket 历史数据
  └─ 通过 Dome API 搜索所有已结算的 "Gold GC Up or Down" 事件
  └─ 获取每个事件的小时级 K 线（Up/Down token 价格）
  └─ 获取每个事件的结算结果（Up 赢还是 Down 赢）

Step 2: 对每个事件运行 AI 模型预测
  └─ 站在前一天视角（只用 target_date 之前的数据）
  └─ 获取历史金价 + 10 个宏观指标
  └─ 训练 Logistic 回归 → 输出 P(Up)

Step 3: 模拟交易
  └─ 遍历每个事件的每个小时级价格点
  └─ 计算 edge = |模型概率 - 市场定价|
  └─ edge > 阈值 → 买入 $1 的对应 token
  └─ 记录每笔交易

Step 4: 结算
  └─ 事件结算后，根据实际结果计算每笔交易的盈亏
  └─ 买对了方向 → 盈利 = (1 - 买入价) / 买入价
  └─ 买错了方向 → 亏损 = -$1

Step 5: 汇总统计
  └─ 胜率、总盈亏、ROI、最大回撤、夏普比率
  └─ 按事件汇总 + 每笔交易明细
```

---

## 六、运行方式

```bash
# 1. 固定概率回测（不用 AI 模型，假设上涨概率固定 60%）
python gold_analyzer/run_backtest.py --prob 0.60 --edge 0.05

# 2. 参数扫描（测试不同概率和 edge 组合）
python gold_analyzer/run_backtest.py --sweep

# 3. AI 模型驱动回测（每个事件动态预测，每小时决策）
python gold_analyzer/run_backtest.py --model --edge 0.05

# 4. 重新获取数据 + 重新预测
python gold_analyzer/run_backtest.py --model --refresh --refresh-predictions

# 5. 调整 edge 阈值
python gold_analyzer/run_backtest.py --model --edge 0.10
```

---

## 七、最新回测结果（2025.10 ~ 2026.02，47 个事件）

| 指标 | 数值 |
|------|------|
| 总交易笔数 | 523 笔（平均每事件 11.1 笔） |
| 胜率 | 38.4%（201 胜 322 负） |
| 总投入 | $523.00 |
| **总盈亏** | **+$267.35** |
| **投资回报率** | **+51.1%** |
| 每笔平均盈亏 | +$0.51 |
| 盈利笔均盈 | +$2.93 |
| 亏损笔均亏 | -$1.00 |
| 模型方向准确率 | 61.7%（29/47 事件） |

**核心发现**：虽然胜率只有 38%，但由于二元期权的不对称性（赢的时候赚 $2.93，输的时候只亏 $1），总体仍然盈利 +51.1%。

---

## 八、文件结构

```
gold_analyzer/
├── polymarket_client.py    # Dome API 客户端，获取 Polymarket 事件+价格数据
├── model_predictor.py      # AI 回归模型预测器（站在前一天预测）
├── backtester.py           # 回测引擎（交易决策、盈亏计算、统计）
├── run_backtest.py         # 回测入口（命令行参数、报告输出）
├── gc_events_cache.json    # Polymarket 事件数据缓存
└── model_predictions_cache.json  # 模型预测结果缓存
```
